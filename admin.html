<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MiniShop</title>
  <link rel="stylesheet" href="admin.css" />
</head>
<style>
.wrapper {
  background-color: blanchedalmond;
  display: grid;
  grid-template-columns: 400px 1fr 1fr; /* Left, middle, right */
  gap: 20px;
  margin-bottom: 20px;
  align-items: start;
  padding: 20px;
}

/* Left column: images in 2 columns */
.left {
  display: grid;
  grid-template-columns: repeat(1, 1fr); /* 2 columns */
  gap: 10px;
}

.left img {
  width: 100%; /* fit the grid cell */
  height: 100px;
  object-fit: cover;
}

.middle input,
.middle label,
.right textarea,
.right button {
  display: block;
  margin-bottom: 10px;
  width: 100%;
}

.right textarea {
  height: 150px;
}

.right button {
  width: 100px;
  padding: 5px 10px;
  margin-right: 10px;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}
</style>


<body>
  

  <div class="content">
    <main class="admin-panel">
      <h2>Add Product</h2>
      <div class="div3">
        <div class="div1">
          <form id="productForm" enctype="multipart/form-data">
            <!-- FIXED: main image as file input -->
            <label>Main Image</label>
            <input type="file" id="image" accept="image/*"/>

            <label>Product Name</label>
            <input type="text" id="name" placeholder="Product Name" required />

            <label>Price</label>
            <input type="number" id="price" placeholder="Price" required />

            <label>Original Price</label>
            <input type="number" id="originalprice" placeholder="Original Price" required />

            <label>Reselling Company</label>
            <input type="text" id="title" placeholder="Reselling Company" required />
        </div>

        <div class="div2" >
          <div class="div6">
            <div class="div4">
              <label>Title:</label>
              <select id="option">
                <option value="">Select Option</option>
                <option value="Hot Deal">Hot Deal</option>
                <option value="New Arrival">New Arrival</option>
                <option value="Special Offer">Special Offer</option>
                <option value="Limited time">Limited time</option>
                <option value="Crazy Deal">Crazy Deal</option>
                <option value="Tranding">Tranding</option>
                <option value="Offer">Offer</option>
                <option value="Bank Offer">Bank Offer</option>
                <option value="Super Offer">Super Offer</option>
                <option value="Special price">Special price</option>
                <option value="Limited offer">Limited offer</option>
                <option value="Get Coupon">Get Coupon</option>
                <option value="Lucky Wahu">Lucky Wahu</option>
                <option value="Lucky Draw">Lucky Draw</option>
                <option value="Lottary">Lottary</option>
              </select>

              <!-- FIXED: more images and video -->
              <br>
              <label>More Images:</label>
              <input type="file" id="moreImages" multiple accept="image/*" />
              <br>
              <label>Video:</label>
              <input type="file" id="video" accept="video/mp4,video/webm" />
              <button type="submit">Add Product</button>
            </div>

            <div class="div9">
              <div class="div5">
                <label><input type="checkbox" name="sizes" value="S"> S</label>
                <label><input type="checkbox" name="sizes" value="M"> M</label>
                <label><input type="checkbox" name="sizes" value="L"> L</label>
                <label><input type="checkbox" name="sizes" value="XL"> XL</label>
                <label><input type="checkbox" name="sizes" value="XXL"> XXL</label>
                <label><input type="checkbox" name="sizes" value="3XL"> 3XL</label>
                <label><input type="checkbox" name="sizes" value="Lottary"> Lottary</label>
                 <label><input type="checkbox" name="sizes" value="Free"> Free</label>
              </div>

              <div class="div7">
                <label><input type="checkbox" name="sizes" value="5"> 5</label>
                <label><input type="checkbox" name="sizes" value="6"> 6</label>
                <label><input type="checkbox" name="sizes" value="7"> 7</label>
                <label><input type="checkbox" name="sizes" value="8"> 8</label>
                <label><input type="checkbox" name="sizes" value="9"> 9</label>
                <label><input type="checkbox" name="sizes" value="5 UK"> 5uk</label>
                <label><input type="checkbox" name="sizes" value="6 UK"> 6uk</label>
                <label><input type="checkbox" name="sizes" value="7 UK"> 7uk</label>
                <label><input type="checkbox" name="sizes" value="8 UK"> 8uk</label>
                <label><input type="checkbox" name="sizes" value="9 UK"> 9uk</label>
                <label><input type="checkbox" name="sizes" value="10 UK"> 10uk</label>
                <label><input type="checkbox" name="sizes" value="11 UK"> 11uk</label>
                <label><input type="checkbox" name="sizes" value="12 UK"> 12uk</label>
              </div>
              <div class="div8">
                <label><input type="checkbox" name="sizes" value="26"> 26</label>
                <label><input type="checkbox" name="sizes" value="28"> 28</label>
                <label><input type="checkbox" name="sizes" value="30"> 30</label>
                <label><input type="checkbox" name="sizes" value="32"> 32</label>
                <label><input type="checkbox" name="sizes" value="34"> 34</label>
                <label><input type="checkbox" name="sizes" value="36"> 36</label>
                <label><input type="checkbox" name="sizes" value="38">38</label>
                <label><input type="checkbox" name="sizes" value="40"> 40</label>
                <label><input type="checkbox" name="sizes" value="Null"> Null</label>
              </div>
              <textarea id="description" placeholder="Description" rows="5"></textarea>
            </div>
          </div>
        </div>
      </div>
      </form>

      <h3>All Products</h3>
      <h3> Search product Id: <input type="text" id="productSearchBar" placeholder="Search by Product ID" style="margin-bottom: 20px; padding: 10px; width: 350px; height: 50px;" /></h3>
      <h3 id="totalCount">Total Products: 0</h3>

      <div id="adminProductList">Loading...</div>
    </main>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const productForm = document.getElementById("productForm");
      const productList = document.getElementById("adminProductList");

      // ADD PRODUCT
      productForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const formData = new FormData();
        formData.append("name", document.getElementById("name").value);
        formData.append("price", document.getElementById("price").value);
        formData.append("originalprice", document.getElementById("originalprice").value);
        formData.append("title", document.getElementById("title").value);
        formData.append("option", document.getElementById("option").value);
        formData.append("description", document.getElementById("description").value);

        const sizes = Array.from(document.querySelectorAll('input[name="sizes"]:checked')).map(cb => cb.value);
        formData.append("sizes", JSON.stringify(sizes));

        // FIXED: send files correctly
        if (document.getElementById("image").files[0]) {
          formData.append("image", document.getElementById("image").files[0]);
        }
        for (let file of document.getElementById("moreImages").files) {
          formData.append("moreImages", file);
        }
        if (document.getElementById("video").files[0]) {
          formData.append("video", document.getElementById("video").files[0]);
        }

        fetch("http://localhost:5000/api/products/add", {
          method: "POST",
          body: formData
        })
          .then(res => res.json())
          .then(() => {
            alert("Product added!");
            productForm.reset();
            loadProducts();
          })
          .catch(err => console.error(err));
      });

      // LOAD PRODUCTS
      function loadProducts() {
        fetch("http://localhost:5000/api/products")
          .then(res => res.json())
          .then(products => {
            document.getElementById("totalCount").textContent = `Total Products: ${products.length}`;

            if (!products.length) {
              productList.innerHTML = "<p>No products found.</p>";
              return;
            }

            productList.innerHTML = "";
            products.forEach(p => {
              const moreImagesHTML = p.moreImages?.length
                ? p.moreImages.map(img => `<img src="${img.url}" alt="More Image" style="width:100px; height:120px; margin:5px;" />`).join("")
                : "";

             const wrapper = document.createElement("div");
wrapper.innerHTML = `
  <div style="margin-bottom:10px;">
    <p>
      <strong>Product ID:</strong> ${p._id} 
      <button onclick="copyProductID('${p._id}')" style="margin-left:10px; padding:2px 6px; background:#007bff; color:white; border:none; border-radius:3px; cursor:pointer; width:100px; height: 30px;">Copy</button>
    </p>
  </div>

  <div class="wrapper">
    <!-- Left column -->
    <div class="left">
      
      <div>${moreImagesHTML}</div>
    </div>

    <!-- Middle column -->
    <div class="middle">
      <form id="form-${p._id}">
        <label>Product Name</label>
        <input type="text" name="name" value="${p.name}" />
        <label>Price</label>
        <input type="number" name="price" value="${p.price}" />
        <label>Original Price</label>
        <input type="number" name="originalprice" value="${p.originalprice}" />
        <label>Main Image</label>
        <input type="file" name="image" accept="image/*" />
        <label>More Images</label>
        <input type="file" name="moreImages" multiple accept="image/*" />
      </form>
    </div>

    <!-- Right column -->
    <div class="right">
      <textarea form="form-${p._id}" name="description">${p.description}</textarea>
      <button type="submit" form="form-${p._id}">Update</button>
      <button type="button" onclick="deleteProduct('${p._id}')">Delete</button>
    </div>
  </div>

  <hr />
`;


              const form = wrapper.querySelector(`#form-${p._id}`);
              form.addEventListener("submit", function (e) {
                e.preventDefault();
                const updateData = new FormData(form);
                const sizes = Array.from(form.querySelectorAll('input[name="sizes"]:checked')).map(cb => cb.value);
                updateData.append("sizes", JSON.stringify(sizes));

                fetch(`http://localhost:5000/api/products/${p._id}`, {
                  method: "PUT",
                  body: updateData
                })
                  .then(res => res.json())
                  .then(() => {
                    alert("Product updated!");
                    loadProducts();
                  })
                  .catch(() => alert("Failed to update product"));
              });

              productList.appendChild(wrapper);
            });
          });
      }

      // DELETE PRODUCT
      window.deleteProduct = function (id) {
        if (!confirm("Are you sure?")) return;
        fetch(`http://localhost:5000/api/products/${id}`, { method: "DELETE" })
          .then(res => res.json())
          .then(() => {
            alert("Product deleted!");
            loadProducts();
          });
      };

      loadProducts();
    });

    function copyProductID(id) {
  navigator.clipboard.writeText(id)
    .then(() => alert(`Product ID ${id} copied!`))
    .catch(() => alert("Failed to copy Product ID."));
}

  </script>
  <script>
  let allProducts = [];

  function loadProducts() {
    fetch("http://localhost:5000/api/products")
      .then(res => res.json())
      .then(products => {
        allProducts = products; // Save for search filtering
        renderProducts(allProducts);
      });
  }

  // Search functionality
  document.getElementById("productSearchBar").addEventListener("input", (e) => {
    const query = e.target.value.toLowerCase();
    const filtered = allProducts.filter(p => p._id.toLowerCase().includes(query));
    renderProducts(filtered);
  });

  function renderProducts(products) {
    const productList = document.getElementById("adminProductList");
    productList.innerHTML = "";

    if (!products.length) {
      productList.innerHTML = "<p>No products found.</p>";
      return;
    }

    products.forEach(p => {
      const moreImagesHTML = p.moreImages?.length
        ? p.moreImages.map(img => `<img src="${img.url}" alt="More Image" style="width:100px; height:120px; margin:5px;" />`).join("")
        : "";

      const wrapper = document.createElement("div");
wrapper.innerHTML = `
  <div style="margin-bottom:10px;">
    <p>
      <strong>Product ID:</strong> ${p._id} 
      <button onclick="copyProductID('${p._id}')" style="margin-left:10px; padding:2px 6px; background:#007bff; color:white; border:none; border-radius:3px; cursor:pointer; width:100px; height: 30px;">Copy</button>
    </p>
  </div>

  <div class="wrapper">
    <!-- Left column -->
    <div class="left">
      
      <div>${moreImagesHTML}</div>
    </div>

    <!-- Middle column -->
    <div class="middle">
      <form id="form-${p._id}">
        <label>Product Name</label>
        <input type="text" name="name" value="${p.name}" />
        <label>Price</label>
        <input type="number" name="price" value="${p.price}" />
        <label>Original Price</label>
        <input type="number" name="originalprice" value="${p.originalprice}" />
        <label>Main Image</label>
        <input type="file" name="image" accept="image/*" />
        <label>More Images</label>
        <input type="file" name="moreImages" multiple accept="image/*" />
      </form>
    </div>

    <!-- Right column -->
    <div class="right">
      <textarea form="form-${p._id}" name="description">${p.description}</textarea>
      <button type="submit" form="form-${p._id}">Update</button>
      <button type="button" onclick="deleteProduct('${p._id}')">Delete</button>
    </div>
  </div>

  <hr />
`;

      const form = wrapper.querySelector(`#form-${p._id}`);
      form.addEventListener("submit", function (e) {
        e.preventDefault();
        const updateData = new FormData(form);
        const sizes = Array.from(form.querySelectorAll('input[name="sizes"]:checked')).map(cb => cb.value);
        updateData.append("sizes", JSON.stringify(sizes));

        fetch(`http://localhost:5000/api/products/${p._id}`, {
          method: "PUT",
          body: updateData
        })
        .then(res => res.json())
        .then(() => {
          alert("Product updated!");
          loadProducts();
        })
        .catch(() => alert("Failed to update product"));
      });

      productList.appendChild(wrapper);
    });
  }

  function copyProductID(id) {
    navigator.clipboard.writeText(id)
      .then(() => alert(`Product ID ${id} copied!`))
      .catch(() => alert("Failed to copy Product ID."));
  }

  window.deleteProduct = function(id) {
    if (!confirm("Are you sure?")) return;
    fetch(`http://localhost:5000/api/products/${id}`, { method: "DELETE" })
      .then(res => res.json())
      .then(() => {
        alert("Product deleted!");
        loadProducts();
      });
  }

  // Initial load
  loadProducts();
</script>
  
</body>
</html>
