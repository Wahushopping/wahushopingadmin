<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pending Returns - Admin</title>
  <link rel="stylesheet" href="catagory.css" />
  <style>
               body{
      padding-left: 50px;
      padding-right: 50px;
    }
    .order-box { border: 1px solid #ccc; padding: 15px; margin: 15px 0; }
    .item-box { margin-left: 15px; border-top: 1px solid #eee; padding-top: 10px; }
    img { border: 1px solid #ddd; }
    #searchBar { margin-bottom: 10px; padding: 5px; width: 250px; }
    .copy-btn { margin-left: 10px; padding: 2px 6px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 3px; }
  </style>
</head>
<body>
  <h1>Pending Return Requests</h1>

  <!-- Search Bar -->
  <input type="text" id="searchBar" placeholder="Search by Order ID" />

  <div id="returnsContainer">Loading...</div>

<script>
  let allOrders = [];

  // Fetch all return requests
  fetch("https://wahuserver.onrender.com/api/orders/returns")
    .then(res => res.json())
    .then(orders => {
      // Filter only pending items
      allOrders = orders.map(order => {
        return {
          ...order,
          items: order.items.filter(item => item.returnRequested && (!item.returnStatus || item.returnStatus === "Pending"))
        };
      }).filter(order => order.items.length > 0);

      renderReturns(allOrders);
    })
    .catch(err => {
      console.error("Error fetching returns:", err);
      document.getElementById("returnsContainer").innerHTML = "<p>Error loading return requests.</p>";
    });

  // Search functionality
  document.getElementById("searchBar").addEventListener("input", (e) => {
    const query = e.target.value.toLowerCase();
    const filtered = allOrders.filter(order => order._id.toLowerCase().includes(query));
    renderReturns(filtered);
  });

  // Render pending return requests
  function renderReturns(orders) {
    const container = document.getElementById("returnsContainer");
    container.innerHTML = "";

    if (!orders.length) {
      container.innerHTML = "<p>No pending return requests found.</p>";
      return;
    }

    orders.forEach(order => {
      const orderDiv = document.createElement("div");
      orderDiv.classList.add("order-box");

      orderDiv.innerHTML = `
        <p>
          <strong>Order ID:</strong> ${order._id}
          <button class="copy-btn" onclick="copyOrderID('${order._id}')">Copy</button>
        </p>
        <p><strong>User:</strong> ${order.address.name} (${order.address.phone})</p>
        <p><strong>Address:</strong> ${order.address.fullAddress}, ${order.address.city}, ${order.address.pincode}</p>
        <p><strong>Total:</strong> ₹${order.total}</p>
        <p><strong>Status:</strong> ${order.status}</p>
      `;

      order.items.forEach(item => {
        const imageUrl = item.image?.url || item.image || "placeholder.jpg";

        // Refund details display
        let refundDetailsHTML = "";
        if (item.refundMethod === "UPI") {
          refundDetailsHTML = `
            <p><strong>Refund Method:</strong> UPI</p>
            <p><strong>UPI ID:</strong> ${item.upi || "N/A"}</p>
          `;
        } 
        else if (item.refundMethod === "Bank" && item.bank) {
  const acc = item.bank.accountNumber || "N/A"; // show full account number
  refundDetailsHTML = `
    <p><strong>Refund Method:</strong> Bank Transfer</p>
    <p><strong>Account Holder:</strong> ${item.bank.name || "N/A"}</p>
    <p><strong>Account Number:</strong> ${acc}</p>
    <p><strong>IFSC Code:</strong> ${item.bank.ifsc || "N/A"}</p>
  `;
}


        orderDiv.innerHTML += `
          <div class="item-box">
            <img src="${imageUrl}" alt="${item.name}" style="width: 50px; height: 50px; object-fit: cover;">
            <p><strong>Product:</strong> ${item.name}</p>
            <p style="margin: 0;">Reselling Company: ${item?.title || 'N/A'}</p>
            <p style="margin: 0;">Price: ₹${item.price}</p>
            <p><strong>Reason:</strong> ${item.returnReason}</p>
            ${refundDetailsHTML}
            <p><strong>Status:</strong> ${item.returnStatus || "Pending"}</p>
            <button onclick="updateReturnStatus('${order._id}', '${item._id}', true)">Approve</button>
            <button onclick="updateReturnStatus('${order._id}', '${item._id}', false)">Reject</button>
          </div>
        `;
      });

      container.appendChild(orderDiv);
    });
  }

  // Copy Order ID
  function copyOrderID(orderId) {
    navigator.clipboard.writeText(orderId)
      .then(() => alert(`Order ID ${orderId} copied!`))
      .catch(() => alert("Failed to copy order ID."));
  }

  // Update return status
  function updateReturnStatus(orderId, itemId, approved) {
    fetch(`https://wahuserver.onrender.com/api/orders/${orderId}/return/${itemId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ approved })
    })
      .then(res => res.json())
      .then(() => {
        alert("Return updated");
        location.reload();
      })
      .catch(err => {
        console.error("Update failed:", err);
        alert("Error updating return");
      });
  }
</script>

</body>
</html>

